import { HttpClient, HttpParams } from "@angular/common/http";
import { Component, Inject, OnInit, ViewChild } from "@angular/core";
import { MatDialogRef, MAT_DIALOG_DATA } from "@angular/material/dialog";
import { MatPaginator } from "@angular/material/paginator";
import { MatSnackBar } from "@angular/material/snack-bar";
import { MatTableDataSource } from "@angular/material/table";
import { ActivatedRoute } from "@angular/router";
import { NgxSpinnerService } from "ngx-spinner";
import { Subject } from "rxjs";
import { takeUntil } from "rxjs/operators";
import { AuthenticationService, UserProfile } from "src/app/services/authentication.service";
import { ConfirmDialogService } from "src/app/services/confirm-dialog.service";
import { DesignSettingsService } from "src/app/services/design-settings.service";
import { VulnerabilityService } from "src/app/services/vulnerability.service";
import { environment } from "src/environments/environment";
@Component({
  selector: "vulnerability-weakness-link-dialog",
  templateUrl: "vulnerability-weakness-link-dialog.html",
  styleUrls: ["vulnerability-weakness-link-dialog.css"]
})
export class VulnerabilityWeaknessLinkDialog implements OnInit {

  @ViewChild(MatPaginator, { static: true }) paginator: MatPaginator;
  displayedColumns: string[] = ['weaknessNumber', 'dateIdentified',
    'identificationMethod', 'sourceNotes', 'component', 'attackSurface', 'asset',
    'weaknessDescription', 'cweId', 'cweWeaknessType', 'cweCategory',
    'vulnerabilitiesLinked'
  ];
  dataSource: MatTableDataSource<any> = new MatTableDataSource<any>([]);
  archivedDataSource: MatTableDataSource<any> = new MatTableDataSource<any>([]);
  originalDataSource = []
  readonly newDesign = JSON.parse(localStorage.getItem("newDesign"));
  currentUserProfile: UserProfile
  private unsubscribe: Subject<void> = new Subject();
  loaded: boolean = false; //Flag for not running the highlight function twice on initial load
  weaknessUrl = `${environment.backendApiUrl}weakness/${this.newDesign.project.id}`
  vulnerabilitiesUrl = `${environment.backendApiUrl}vulnerability/${this.newDesign.project.id}`
  tabIndex = 0;
  confirmToCancel = {
    title: "CONFIRMATION",
    message: "Are you sure you want to discard all of your linking changes?",
    cancelText: "No",
    confirmText: "Yes",
    color: "primary"
  };
  weaknessType = ["Software Development", "Hardware Design"];
  weaknessCategory = [
    [
      "API/Function Errors",
      "Audit / Logging Errors",
      "Authentication Errors ",
      "Authorization Errors ",
      "Bad Coding Practices",
      "Behavioral Problems",
      "Business Logic Errors",
      "Communication Channel Errors",
      "Complexity Issues",
      "Concurrency Issues",
      "Credentials Management Errors",
      "Cryptographic Issues",
      "Data Integrity Issues",
      "Data Neutralization Issues",
      "Data Processing Errors",
      "Data Validation Issues",
      "Documentation Issues",
      "Encapsulation Issues",
      "Error Conditions, Return Values, Status Codes",
      "Expression Issues",
      "File Handling Issues",
      "Handler Errors",
      "Information Management Errors",
      "Initialization and Cleanup Errors",
      "Key Management Errors",
      "Lockout Mechanism Errors",
      "Memory Buffer Errors",
      "Numeric Errors",
      "Permission Issues",
      "Pointer Issues",
      "Privilege Issues",
      "Random Number Issues",
      "Resource Locking Problems",
      "Resource Management Errors",
      "Signal Errors",
      "State Issues",
      "String Errors",
      "Type Errors",
      "User Interface Security Issues",
      "User Session Errors"
    ],
    [
      "Core and Compute Issues ",
      "Cross-Cutting Problems",
      "Debug and Test Problems",
      "General Circuit and Logic Design Concerns",
      "Integration Issues",
      "Manufacturing and Life Cycle Management Concerns",
      "Memory and Storage Issues",
      "Peripherals, On-chip Fabric, and Interface/IO Problems",
      "Power, Clock, and Reset Concerns",
      "Privilege Separation and Access Control Issues",
      "Security Flow Issues",
      "Security Primitives and Cryptography Issues"
    ]
  ];

  confirmToDelete = {
    title: "CONFIRMATION",
    message: "Are you sure you want to delete this weakness? This will unlink all vulnerabilities that are linked to this weakness",
    cancelText: "No",
    confirmText: "Yes",
  };
  changedItems = [];

  constructor(private http: HttpClient, private _authService: AuthenticationService,
    private _spinner: NgxSpinnerService, private _vulnerabilityService: VulnerabilityService, private activatedRoute: ActivatedRoute,
    private route: ActivatedRoute, private _snackBar: MatSnackBar,
    public editDesignShared: DesignSettingsService, private _confirmDialogService: ConfirmDialogService,
    @Inject(MAT_DIALOG_DATA) public data: any,
    public dialogRef: MatDialogRef<VulnerabilityWeaknessLinkDialog>
  ) { }
  /*fetch weakness from backend, convert it to FE model and update data source
    if user is coming from notification component, scroll to that specific vulnerability and highlight it for 8 seconds
  */
  ngOnInit(): void {
    this.getProjectWeaknesses()
  }

  getProjectWeaknesses() {
    this._spinner.show("weakness-spinner");
    let params = new HttpParams().set("activeData", "true").set("id", this.newDesign.project.id);
    this.http.get(this.weaknessUrl, { params }).pipe(takeUntil(this.unsubscribe))
      .subscribe((data: any[]) => {
        this.dataSource.data = data;
        this.dataSource.data.forEach(item => {
          if (item.linkedVulnerabilities.includes(this.data.row._id)) {
            item.linked = true;
          } else {
            item.linked = false;
          }
        })
        this.originalDataSource = [...this.dataSource.data];
        this._spinner.hide("weakness-spinner");
        // this.highlightRow()
        this.loaded = true
      },
        (error) => this._spinner.hide("weakness-spinner"),
        () => this._spinner.hide("weakness-spinner")
      )
    this.currentUserProfile = this._authService.currentUserValue();
  }

  ngAfterViewInit() {
    this.dataSource.paginator = this.paginator;
  }

  ngOnDestroy() {
    this.unsubscribe.next();
    this.unsubscribe.complete();
  }


  /*Trigers from delete and add functions to update the data sourse of grid. We have to keep copy of original data
    so that we don't loose data while showing search results.
  */
  updateDataSource() {
    this.dataSource.data = [...this.dataSource.data]
    this.originalDataSource = [...this.dataSource.data]
  }

  closeDialog() {
    this._confirmDialogService.open(this.confirmToCancel);
    this._confirmDialogService.confirmed().subscribe((confirmed) => {
      if (confirmed) {
        this.dialogRef.close();
      }
    })
  }

  /*converts boolean value of reviewed and validated to yes and no to show on checkboxes*/
  convertBoolToYesNo(rowBooleanVals) {
    return rowBooleanVals ? 'Yes' : 'No'
  }

  /*checkbox is ticked add the weakness to the list of changedItems
    to send to the backend only the weaknesses which are actually linked or unlinked
  */
  linkedChanged($event, row) {
    const i = this.dataSource.data.findIndex(item => item._id == row._id);
    const alreadyExists = this.changedItems.indexOf(this.dataSource.data[i])
    if ($event.checked) {
      this.dataSource.data[i].linkedVulnerabilities.push(this.data.row._id);
    } else if (!$event.checked) {
      const index = this.dataSource.data[i].linkedVulnerabilities.indexOf(this.data.row._id);
      this.dataSource.data[i].linkedVulnerabilities.splice(index, 1);
    }

    if (alreadyExists > -1) {
      this.changedItems[alreadyExists] = this.dataSource.data[i];
    } else {
      this.changedItems.push(this.dataSource.data[i]);
    }
  }

  updateVulnerabilities() {
    const weaknesses = this.changedItems.map(function (row) {
      return { _id: row._id, linkedVulnerabilities: row.linkedVulnerabilities }
    });
    const linkedWeaknesses = [];
    this.dataSource.data.map(item => {
      if (item.linkedVulnerabilities.includes(this.data.row._id) && item?._id) {
        linkedWeaknesses.push(item._id)
      }
    })
    const vulnerabilityData = { _id: this.data.row._id, linkedWeaknesses };
    const data = { weaknesses, linkedVulnerabilities: true, vulnerabilityData, projectId:this.newDesign.project.id };
    this.dialogRef.close(data)
  }

}