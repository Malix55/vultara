import { HttpClient } from "@angular/common/http";
import { Inject } from "@angular/core";
import { Component, OnInit } from "@angular/core";
import { FormBuilder, FormGroup, Validators } from "@angular/forms";
import { MatDialogRef, MAT_DIALOG_DATA } from "@angular/material/dialog";
import { MatSnackBar } from "@angular/material/snack-bar";
import { Subject } from "rxjs";
import { takeUntil } from "rxjs/operators";
import { AuthenticationService, UserProfile } from "src/app/services/authentication.service";
import { environment } from "src/environments/environment";
@Component({
    selector: "add-update-vulnerability",
    templateUrl: "add-update-vulnerability.component.html",
    styleUrls: ["add-update-vulnerability.component.css"]
})
export class AddUpdateVulnerabilityDialog implements OnInit {

    readonly featureRootUrl = environment.backendApiUrl + "features";
    vulnerabilityForm:FormGroup;
    private unsubscribe: Subject<void> = new Subject();
    treatments: string[] = ["no treatment", "reduce", "retain", "avoid", "share"];
    edit = `Edit vulnerability No:${this.data.row.no}`;
    today = new Date();
    currentUserProfile:UserProfile;
    validationRevoked: boolean = false;
    reviewRevoked: boolean = false;
    nvdVulnerability: boolean = false;

    constructor(private http: HttpClient,private _snackBar: MatSnackBar, @Inject(MAT_DIALOG_DATA) public data: any,
    public dialogRef: MatDialogRef<AddUpdateVulnerabilityDialog>,private _formBuilder:FormBuilder,
    private _authService: AuthenticationService) {
     if(data.row.vulnerabilitySource=="nvd"){
      this.nvdVulnerability = true;
     }
    }

    ngOnInit() {
      this.vulnerabilityForm = this._formBuilder.group({
        no: this.data.row.no,
        cveDataMetaIds:{value:"",disabled:this.nvdVulnerability},
        component: [{value:"",disabled:this.nvdVulnerability},[Validators.required,Validators.pattern(".*[^ ].*")]],
        description: {value:"",disabled:this.nvdVulnerability},
        reviewed: false,
        treatment: "no treatment",
        baseScore: [{value:0,disabled:this.nvdVulnerability},[Validators.pattern(/^\s*(?=.*[0-9])\d*(?:\.\d{1,2})?\s*$/),Validators.required,Validators.max(10)]],
        baseSeverity: "",
        publishedDate: {value:"",disabled:this.nvdVulnerability},
        hbom:{value:"",disabled:this.nvdVulnerability},
        sbom:[{value:"",disabled:this.nvdVulnerability},[Validators.required,Validators.pattern(".*[^ ].*")]],
        _id:"",
        vulnerabilitySource:"",
        highlighted:false,
        lastModifiedBy: "",
        reviewedBy: "",
        reviewedDateTime: undefined,
        reviewStatusRevokedBy: "",
        reviewedStatusRevokedDateTime: undefined,
        treatmentStatusChangedBy: "",
        treatmentPickedDateTime: undefined,
        validated:false,
        validatedBy: "",
        validatedDateTime:undefined,
        validateStatusRevokedBy: "",
        validationRevokedDateTime:undefined,
        linkedWeaknesses:[]
      });
      
      if(this.data.type=='updated'){// If mode is updated then patch the form with row values
        this.vulnerabilityForm.patchValue(this.data.row);
        this.vulnerabilityForm.patchValue({sbom:this.data.row.sbom?.product,hbom:this.data.row.hbom?.product});
      }

      this._authService.currentUserObservable
      .pipe(takeUntil(this.unsubscribe))
      .subscribe((currentUser) => {
        this.currentUserProfile = currentUser
      });
    }

    confirmChanges(){
      let data = this.vulnerabilityForm.getRawValue();
      const sbomProduct = data?.sbom;
      const hbomProduct = data?.hbom;
      if(this.data.type=='updated'){
        data.sbom = this.data.row.sbom;
        if(data?.sbom?.product){
          data.sbom.product = sbomProduct
        }
        data.hbom = this.data.row.hbom;
        if(data?.hbom?.product || data?.hbom?.product==''){
          data.hbom.product = hbomProduct
        }
      }else{
        data.sbom = {product:sbomProduct}
        data.hbom = {product:hbomProduct}
      }
      data.baseSeverity = this.setSeverity(data)
      data.lastModifiedBy = this.currentUserProfile._id;
      let manual = false;
      if(data.vulnerabilitySource == ''){//If user added vulnerability is being updated
        manual = true;
      }
      data =  Object.entries(data).reduce((a,[k,v]) => (v === null||v===""? a : (a[k]=v, a)), {}); //Remove null and empty string keys from object
      const formData = this.vulnerabilityForm.getRawValue()
      if(this.data.row.manual){
        data.cveDataMetaIds = formData.cveDataMetaIds;
        data.description = formData.description;
        data.publishedDate = formData.publishedDate;
        data.isNotified = true;
        data.raisedBy = this.currentUserProfile._id;
        data.vulnerabilitySource = "";
      }
      if(manual){
        data.vulnerabilitySource = "";
      }

      if(this.reviewRevoked){
        data.reviewedBy = "";
      }
      if(this.validationRevoked){
        data.validatedBy = "";
      }
      this.dialogRef.close(data);
    }

    setSeverity(row) {
      if (row.baseScore >= 0.1 && row.baseScore <= 3.99) {
        return "LOW"
      } else if (row.baseScore >= 4 && row.baseScore <= 6.99) {
        return "MEDIUM"
      } else if (row.baseScore >= 7 && row.baseScore <= 8.99) {
        return "HIGH"
      } else if (row.baseScore >= 9 && row.baseScore <= 10) {
        return "CRITICAL"
      }else{
        return "NONE"
      }
    }

    ngOnDestroy(){
      this.unsubscribe.next();
      this.unsubscribe.complete();
    }

    onNoClick(): void {
      // function to close dialog
      this.dialogRef.close();
    }

    treatment(event){
      this.vulnerabilityForm.patchValue({treatmentStatusChangedBy:this.currentUserProfile._id,treatmentPickedDateTime:new Date()})
    }

    reviewedChecked(event){
      if(event.checked && event.source.id){
        this.vulnerabilityForm.patchValue({reviewedBy:this.currentUserProfile._id,reviewedDateTime:new Date()})
        this.reviewRevoked = false;
      }
      if(!event.checked && event.source.id){
        this.vulnerabilityForm.patchValue({reviewStatusRevokedBy:this.currentUserProfile._id,reviewedStatusRevokedDateTime:new Date(),reviewedBy:""})
        this.reviewRevoked = true;
      }
    }

    validatedChecked(event){
      if(event.checked){
        this.vulnerabilityForm.patchValue({validatedBy:this.currentUserProfile._id,validatedDateTime:new Date()})
        this.validationRevoked = false;
      }
      if(!event.checked){
        this.vulnerabilityForm.patchValue({validateStatusRevokedBy:this.currentUserProfile._id,validationRevokedDateTime:new Date(),validatedBy:""})
        this.validationRevoked = true;
      }
    }
    
}